{%extends "base.html"%}
{% block title %}{{card_list.name}}{% endblock %}
{%block content%}
	<div id="app">
		<div class="filters">
      <div class="filter">
        <p>Состояние</p>
			<form >
				<p><input v-model="cond" type="checkbox"  name="cond" value="M">M</p>
				<p><input v-model="cond" type="checkbox"  name="cond" value="NM">NM</p>
				<p><input v-model="cond" type="checkbox"  name="cond" value="SP">SP</p>
				<p><input v-model="cond" type="checkbox"  name="cond"  value="HP">HP</p>
			</form>
      </div>
      <div class="filter">
      <p>Фойла</p>
      <form>
        <p><input type="radio" value="F" name="foil" v-model="foil">Только фоил</p>
        <p><input type="radio" value="N" name="foil" v-model="foil">Только не фоил</p>
        <p><input type="radio" value="D" name="foil" v-model="foil">Без разницы</p>
      </form>
      </div>
      <div class="filter">
        <p>Сортировка</p>
      <form>
        <p><input type="radio" value="price(dec)" name="sort" v-model="sort">по цене(убыв)</p>
        <p><input type="radio" value="price(inc)" name="sort" v-model="sort">по цене(возрас)</p>
        <p><input type="radio" value="alph" name="sort" v-model="sort">по алфавиту</p>
        <p><input type="radio" value="def" name="sort" v-model="sort">сбросить</p>
      </form>
    </div>
		</div>
		<table class="list">
			<tr><th>Card Name</th><th>Price</th><th>Owner's price</th><th>Condition</th></tr>
			<tr v-for="card in sorted_cards" v-if="filt(card)">
        <td>[[card.name]]</td>
        <td>[[card.price]]$</td>
        <td v-if="!card.edit_mode">[[card.my_price]]$</td>
        <td v-if="card.edit_mode">
            <input type="text" v-on:keyup.enter="change_my_price(card.id,$event.target.value)" :placeholder="card.my_price"></td>
        <td>[[card.condition]]</td>
        <td><a href="#" v-on:click="card.edit_mode=true">edit</a></td>
        <td><a href="#" v-on:click="delete_el(card.id)">X</a></td>
      </tr>
      <tr>
        <form method="POST">
          {%csrf_token%}
          <td><input type="text" v-model="new_card['name']" name="name" maxlength="100" required id="id_name" /></td>
          <td></td>
          <td><input type="number" v-model="new_card['my_price']" name="my_price" value="0" step="any" id="id_my_price" /></td>
          <td>
              <select v-model="new_card['condition']" name="condition" id="id_condition">
                <option value="M">M</option>
                <option value="NM" selected>NM</option>
                <option value="SP">SP</option>
                <option value="HP">HP</option>
              </select>
          </td>
          <td>
           <input type="submit" v-on:click="submit_new_card" value="Добавить">
          </td>
      </form>
    </tr>
		</table>
	</div>
<script>
let app = new Vue({
  el: '#app',
  delimiters: ['[[', ']]'],
  data: {
    cards:[],
    cond:[],
    sort:"def",
    foil:"D",
    new_card:[],
  		},
  methods:{


  	loadCards:function(){
  		let xhttp = new XMLHttpRequest();
  		xhttp.onreadystatechange = function(){
  			if(this.readyState == 4 && this.status==200){
  			for(i of JSON.parse(this.responseText)){
          i["edit_mode"]=false;
  				app.cards.push(i);
  			}}
  		}
  		xhttp.open("GET", `${document.location.pathname.split("/")[2]}/cards`, true);
  		xhttp.send();},



      filt:function(card){
        condition = app.cond.length==0|app.cond.findIndex((i)=>i==card.condition)!=-1;
        foil = card.foil&app.foil=="F"|(!card.foil)&app.foil=="N"|app.foil=="D";
        return condition&foil;
      },


      change_my_price:function(id, value){

        let url = "{%url 'plist:change_my_price' %}";
        fetch(url, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            "X-CSRFToken":"{{csrf_token}}"
          },
          credentials:"same-origin",
          body: JSON.stringify({"card_id":id, "my_price":value})
        }).then((response)=>{
          console.log(response);
          for (var i = 0; i < this.cards.length; i++) {
            if(this.cards[i].id==id){
            this.cards[i]["my_price"]=value;
            this.cards[i].edit_mode=false;}
          }
        }).catch((error)=>{
          console.log(error);
        })
      },


      submit_new_card:function(){
        let url = "{%url 'plist:add_new_card' %}";
        new_card = this.new_card
        new_card["card_list"] = {{card_list.id}};
        fetch(url, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            "X-CSRFToken":"{{csrf_token}}"
          },
          credentials:"same-origin",
          body: JSON.stringify(new_card)
        }).then((response)=>{
          console.log(response);
          this.new_card = {};
          this.loadCards();
        }).catch((error)=>{
          console.log(error);
        })
      },


      delete_el:function(id){
        let url = "{%url 'plist:delete_card' %}";
        fetch(url, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            "X-CSRFToken":"{{csrf_token}}"
          },
          credentials:"same-origin",
          body: JSON.stringify({"card_id":id})
        }).then((response)=>{
        console.log(response);
          new_cards = [];
          for (var i = 0; i < this.cards.length; i++) {
            if(this.cards[i].id!=id){
            new_cards.push(this.cards[i]);}
          }
          this.cards = new_cards;
      }).catch((error)=>{
          console.log(error);
        })
      }
  	},



  computed:{
    sorted_cards:function(){
      sorted = this.cards.slice(0)
      if(this.sort=="price(inc)"){
        sorted.sort(function(a,b){return a.price-b.price})
      }else if(this.sort=="price(dec)"){
        sorted.sort(function(a,b){return b.price-a.price})
      }else if(this.sort=="alph"){
        sorted.sort(function(a,b){if(b.name>a.name){return -1}else{return +1}})
      }
      return sorted
    }
  }
  })
	app.loadCards()

</script>
{%endblock%}
